// Prisma Schema文件
// 定义数据库连接和数据模型

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id        Int       @id @default(autoincrement())
  username  String    @unique @db.VarChar(50)
  email     String    @unique @db.VarChar(100)
  password  String    @db.VarChar(255)
  avatar    String?   @db.VarChar(500)
  role      Role      @default(USER)
  status    Int       @default(1) @db.SmallInt // 0: 禁用, 1: 正常
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // 关联关系
  articles  Article[]
  comments  Comment[]
  favorites Favorite[]

  @@map("users")
}

// 用户角色枚举
enum Role {
  USER
  ADMIN
}

// 分类表
model Category {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(50)
  slug        String    @unique @db.VarChar(50)
  description String?   @db.VarChar(500)
  parentId    Int?      @map("parent_id")
  sort        Int       @default(0) @db.SmallInt
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // 关联关系
  articles    Article[]

  @@map("categories")
}

// 文章表
model Article {
  id         Int            @id @default(autoincrement())
  title      String         @db.VarChar(200)
  content    String         @db.Text
  summary    String         @db.VarChar(500)
  cover      String?        @db.VarChar(500)
  categoryId Int            @map("category_id")
  authorId   Int            @map("author_id")
  views      Int            @default(0)
  status     ArticleStatus  @default(PUBLISHED)
  tags       String[]       // PostgreSQL数组类型
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")

  // 关联关系
  category   Category       @relation(fields: [categoryId], references: [id])
  author     User           @relation(fields: [authorId], references: [id])
  comments   Comment[]
  favorites  Favorite[]

  @@index([categoryId])
  @@index([authorId])
  @@index([status])
  @@index([createdAt])
  @@map("articles")
}

// 文章状态枚举
enum ArticleStatus {
  DRAFT      // 草稿
  PUBLISHED  // 已发布
  ARCHIVED   // 已下架
}

// 评论表
model Comment {
  id        Int           @id @default(autoincrement())
  articleId Int           @map("article_id")
  userId    Int           @map("user_id")
  content   String        @db.VarChar(1000)
  parentId  Int?          @map("parent_id")
  likes     Int           @default(0)
  status    CommentStatus @default(PENDING)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  // 关联关系
  article   Article       @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]     @relation("CommentReplies")

  @@index([articleId])
  @@index([userId])
  @@index([status])
  @@map("comments")
}

// 评论状态枚举
enum CommentStatus {
  PENDING   // 待审核
  APPROVED  // 已通过
  REJECTED  // 已拒绝
}

// 收藏表
model Favorite {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  articleId Int      @map("article_id")
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@index([userId])
  @@index([articleId])
  @@map("favorites")
}
